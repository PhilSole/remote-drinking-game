// ==================================================================
//
//  This module names some global stuff then kicks off the app
//
// ==================================================================

// Global variable to namespace modules
let codrink19 = {};

// Global DOM variables
let $body;
let $viewHome, $viewWaiting, $viewGame, $viewLoading;

// Global objects
let socket;
let urlParams;
let playerData = {};
let roomData = {};


// Kickoff when the document is ready
$(document).ready(function() {
    // Save global DOM references
    initGlobalDOMVars();

    // Check for existing game data in URL or localStorage
    getExistingGameData();

    // Initialise socket.io-client
    socket = io();

    // Only direct when the socket connects
    socket.on('connect', (e) => {
        directVisitor();
    });

    // Initialise the home module
    codrink19.home.init(); 
    
});

function initGlobalDOMVars() {
    $body = $('body');
    $viewHome = $body.find('.view.home');
    $viewWaiting = $body.find('.view.waiting-room');
    $viewGame = $body.find('.view.game');
    $viewLoading = $body.find('.view.loading');
}

function getExistingGameData() {
    // Check if localStorage values
    playerData.id = localStorage.getItem('id');

    // Check query params for roomKey, if localStorage is expired this might be relevant
    urlParams = new URLSearchParams(window.location.search);
    playerData.roomKey = urlParams.get('r');
}

function directVisitor() {
    // Direct based on data presence
    if(playerData.id) {
        // codrink19.connection.reconnection();  

    } else if(playerData.roomKey) {
        // No local storage but roomKey in query params so new player but room may be started, finished, or waiting.
        // New player always has to go through the waiting room though so they can enter a nickname

        if(playerData.roomKey === 'gameover') {
            codrink19.home.gameNotFound();    
        } else {
            codrink19.home.allowJoinGame();   
        }
        
    } else {
        // No local storage or roomKey
        codrink19.home.allowNewGame();
    }
}
// ==================================================================
//
//  This module handles player disconnection and reconnection
//
// ==================================================================
codrink19.connection = function() {

    let reconnection = function() {

        socket.emit('request reconnection', playerData.id, function(gameExists, allPlayers, roomObject, minigames) {
            
            if(gameExists) {

            } else {
                console.log('it doesnt');
            }
        });      


    }

    return {
        reconnection: reconnection
    }
}();
// ==================================================================
//
//  This module handles the home/splash view
//
// ==================================================================
codrink19.home = function() {
    let $announcement, $connectMessage, $connectHeading; 
    let $buttonStart;

    let init = function() {
        // Set DOM references
        $announcement = $viewHome.find('.announcements');
        $connectMessage = $viewHome.find('.connecting-message');
        $connectHeading = $connectMessage.find('.heading');
        $ellipses = $connectMessage.find('.ellipses');
        $buttonStart = $viewHome.find('.button-start');
        $buttonJoin = $viewHome.find('.button-join');

        // Update the splash screen with custom content based on data in URL or localStorage
        updateSplash();
    }

    function updateSplash() {
        if(playerData.id) {
            $connectHeading.text('Reconnecting');
        } else if(playerData.roomKey) {
            roomData.creator = urlParams.get('n');
            if(roomData.creator) {
                $announcement.text(roomData.creator + ' invited you').addClass('show-block');
            } else {
                $announcement.text('Checking your invite').addClass('show-block');
            }
        }
    }

    // Show the new game button when client can connect
    let allowNewGame = function(showMessage) {
        if(!showMessage) {
            $connectMessage.addClass('hide-me');
        }
        
        $buttonStart.addClass('show-block');

        $buttonStart.on('click', function() {
            codrink19.waitingRoom.init();
        });        
    }

    // Show the new game button when client can connect
    let allowJoinGame = function() {
        $connectMessage.addClass('hide-me');
        $buttonJoin.addClass('show-block');

        $buttonJoin.on('click', function() {
            codrink19.waitingRoom.init(playerData.roomKey);
        });        
    }

    let gameNotFound = function() {
        $connectHeading.text('Game not found!');
        if(roomData.creator) {
            $announcement.text(roomData.creator + "'s game has finished");
        } else {
            $announcement.text("Whoops");  
        }
        $ellipses.addClass('hide-me');
        allowNewGame(true);
    }

    return {
        init: init,
        allowNewGame: allowNewGame,
        allowJoinGame: allowJoinGame,
        gameNotFound: gameNotFound
    } 
}();
// ==================================================================
//
//  This module handles the waiting room logic
//
// ==================================================================
codrink19.waitingRoom = function() {

    let $headerWrap, $main, $sub;
    let $formWrap, $form, $playerName;
    let $shareStartWrap, $shareLink, $btnBegin;
    let $waitingWrap, $waitingList, $roomCount;
    
    let init = function(roomKey) {
        // Set DOM references  
        
        $headerWrap = $viewWaiting.find('.header-wrap');
        $main = $headerWrap.find('.main');
        $sub = $headerWrap.find('.sub');

        $formWrap = $viewWaiting.find('.nickname-form-wrap');
        $form = $formWrap.find('.formPlayer');
        $feedback = $formWrap.find('.form-feedback');
        $playerName = $form.find('#playerName');

        $shareStartWrap = $viewWaiting.find('.share-start-wrap');
        $shareLink = $shareStartWrap.find('.share-link');
        $btnBegin = $shareStartWrap.find('.begin');

        $waitingWrap = $viewWaiting.find('.waiting-list-wrap');
        $waitingList = $waitingWrap.find('#waitingList');
        $roomCount = $waitingWrap.find('.room-count');
        

        // Either joining an existing room or creating a new one
        if(roomKey) {
            socket.emit('see waiting room', roomKey, function(otherplayers) {
                otherplayers.forEach(player => {
                    $waitingList.append('<li>' + player['nickname'] + '</li>');    
                });
                $waitingWrap.addClass('show-block');
            });

            $main.text("You're connected");
            $sub.text('Enter a nickname to join the player list.');

        } else {
            console.log('no room ID to join');
        }

        $form.on('submit', function(e) {
            e.preventDefault();

            // Get the 'name' value from the form and validate it
            let nickname = $playerName.val();
            if(nickname) {
                if(!roomKey) {

                    // New game so give it an ID
                    let lock = Math.random().toString(36).slice(-6);

                    // Emit a socket event with new player name and room
                    socket.emit('new game request', nickname, lock, function() {
                        // Set in-memory and local storage values for player ID and name
                        setPlayerData(socket.id, nickname, lock);
                    });

                    // Construct the game share link
                    let gameURL = location.protocol + '//' + location.host + '/join?r=' + lock + '&n=' + nickname;

                    // Update the view
                    $formWrap.addClass('hide-me');
                    $waitingList.append('<li>' + nickname + '</li>');
                    $shareLink.text(gameURL).addClass('show-block');
                    $waitingWrap.addClass('show-block');
                    $main.text("Thanks, " + nickname);
                    $sub.text('Share this link with your friends so they can join the game.');
                } else {                        

                    // Emit a socket event with new player name and the room to join
                    socket.emit('join room', nickname, roomKey, function(allPlayers) {
                        // Set local storage values for player ID and name Existing game so room given
                        setPlayerData(socket.id, nickname, roomKey);
                        updateWaitingList(allPlayers);
                    });

                    // Update the view
                    $formWrap.addClass('hide-me');
                }
            } else {
                $feedback.html('But what will we call you?');
                $playerName.one('input', function() {
                    $feedback.html('');
                });
            }
        });
        
        socket.on('new member', function(players) {
            updateWaitingList(players);
        });

        $btnBegin.on('click', function() {
            socket.emit('start game request', playerData.room, function(allPlayers, roomobject, minigames) {
                codrink19.game.init(allPlayers, roomobject, minigames);
            });
        });
        
        socket.on('game start', function(allPlayers, roomobject, minigames) {
            codrink19.game.init(allPlayers, roomobject, minigames);
        });

        $playerName.focus();

        // Waiting room is ready so transition views
        $viewHome.removeClass('active');
        $viewWaiting.addClass('active');


        function setPlayerData(id, nickname, roomKey) {
            playerData.id = id;
            playerData.nickname = nickname;
            playerData.roomKey = roomKey;

            // localStorage.setItem('id', id);
            // localStorage.setItem('nickname', nickname);
            // localStorage.setItem('roomKey', roomKey);
        }

        function updateWaitingList(allPlayers) {
            $waitingList.html('');
            
            allPlayers.forEach(player => {
                $waitingList.append('<li>' + player.nickname + '</li>');    
            });

            $roomCount.html(allPlayers.length + ' players');

            if(allPlayers.length > 1) {
                $btnBegin.addClass('show-block');
            }
        }
    }

    return {
        init: init
    } 
}();


// ==================================================================
// 
//  This module handles the game
// 
// ==================================================================

codrink19.game = function() {
    let $currentPlayerName, $nextPlayerName, $yourTurnMessage, $waitingForMessage;

    let allPlayers, currentPlayer, nextPlayer;

    let subgames;

    let init = function(players, room, minigames) {
        console.log(players, room, minigames);

        $currentPlayerName = $viewGame.find('.current-player-name');
        $nextPlayerName = $viewGame.find('.next-player-name');
        $yourTurnMessage = $viewGame.find('.your-turn-message');
        $waitingForMessage = $viewGame.find('.waiting-for-message');

        allPlayers = players;
        subgames = minigames;

        // Loop through the players data from the server and set up the turn
        players.forEach((player, index) => {
            // Find who's turn it is
            if(player['id'] == room['turn']) {
                // Set the local current player var
                currentPlayer = player;
                setNextPlayer(index);
            }
        });

        if(currentPlayer.id == playerData.id) {
            thisPlayersTurn();
        } else {
            anotherPlayersTurn();
        }


        $viewWaiting.removeClass('active');
        $viewGame.addClass('active');
        
    }

    function anotherPlayersTurn() {
        console.log('another players turn');
        $currentPlayerName.text(currentPlayer.name);
        $waitingForMessage.addClass('show');
    }

    function setNextPlayer(currentindex) {
        let nextIndex;

        if(currentindex == allPlayers.length - 1) {
            nextIndex = 0;
        } else {
            nextIndex = currentindex + 1;
        }

        if(allPlayers[nextIndex].id == playerData.id) {
            $nextPlayerName.text('You!');    
        } else {
            $nextPlayerName.text(allPlayers[nextIndex].name);
        } 
    }



    // =========================================================
    // Helper functions
    // =========================================================
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    return {
        init: init
    } 
}();