// ==================================================================
//
//  This module names some global stuff then kicks off the app
//
// ==================================================================

// Global variable to namespace modules
let codrink19 = {};

// Global DOM variables
let $body;

// Global objects
let socket;

$(document).ready(function() {

    // Assign global DOM variables
    $body = $('body');

    // Initialise modules
    codrink19.connection.init();

    if($body.is('.waiting-room')) {
        codrink19.waitingRoom.init();    
    }
    
});
// ==================================================================
//
//  This module handles the player connections to the game
//
// ==================================================================
codrink19.connection = function() {
    
    let init = function() {
        console.log('This client initiated a new socket connection');

        // Initialise socket.io-client
        socket = io();

        // Check if this is just a reconnection or a new connection
        let playerRoom = localStorage.getItem('playerRoom');
        if(playerRoom) { 
            socket.emit('credentials', playerRoom); 
        } else {
            codrink19.allowStart.init();
        }

        socket.on('room check', function(available) {
            if(available) {
                console.log('the room is available');
            } else {
                codrink19.allowStart.init();
            }
        });
    }

    return {
        init: init
    } 
}();
// ==================================================================
//
//  This module handles a game being created
//
// ==================================================================
codrink19.allowStart = function() {

    let $buttonStart;
    
    let init = function() {
        $buttonStart = $body.find('.button-start');

        $buttonStart.on('click', function() {

            let gameURL = location.protocol + '//' + location.host + '/?game=new';

            window.location = gameURL;
        });
        
    }

    return {
        init: init
    } 
}();
// ==================================================================
//
//  This module handles the waiting room logic
//
// ==================================================================
codrink19.waitingRoom = function() {

    let $formWrap, $form, $playerName;
    let $waitingWrap, $waitingList, $shareLink;
    
    let init = function() {
        
        $formWrap = $body.find('.nickname-form-wrap');
        $form = $formWrap.find('.formPlayer');
        $playerName = $form.find('#playerName');
        $waitingWrap = $body.find('.waiting-list-wrap');
        $waitingList = $waitingWrap.find('#waitingList');
        $shareLink = $waitingWrap.find('.share-link');
        

        $form.on('submit', function(e) {
            e.preventDefault();
            let name = $playerName.val();
            if(name) {
                $formWrap.addClass('hide');
                $waitingList.append('<li>' + name + '</li>');
                let roomID = socket.id;
                let gameURL = location.protocol + '//' + location.host + '/?game=' + socket.id;
                $shareLink.append('<a href="' + gameURL + '">' + gameURL + '</a>');
                $waitingWrap.addClass('show');

                localStorage.setItem('playerID', socket.id);
                localStorage.setItem('playerRoom', socket.id);
                localStorage.setItem('playerName', name);
                socket.emit('new game request');
            } else {
                $form.find('.form-feedback').html('But what will we call you?');
                $playerName.one('change', function() {
                    $form.find('.form-feedback').html('');
                });
            }
        });
        
    }

    return {
        init: init
    } 
}();

